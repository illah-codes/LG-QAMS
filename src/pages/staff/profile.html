<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile - LG QAMS</title>
    <link rel="stylesheet" href="/src/styles/flowbite-tokens.css" />
    <link rel="stylesheet" href="/src/styles/variables.css" />
    <link rel="stylesheet" href="/src/styles/flowbite.css" />
    <link rel="stylesheet" href="/src/styles/main.css" />
  </head>
  <body>
    <div id="app">
      <div class="container page-container max-width-container">
        <!-- Page Header -->
        <div class="page-header">
          <h1 class="page-title">Profile Settings</h1>
          <p class="page-subtitle">Manage your account information</p>
        </div>

        <!-- Profile Information -->
        <div class="card shadow-sm card-spacing">
          <div class="card-header p-6">
            <h2 class="section-title">Personal Information</h2>
          </div>
          <div class="card-body p-6">
            <form onsubmit="updateProfile(event)">
              <div class="grid-2-col">
                <div>
                  <label for="profile-name" class="form-label">Full Name</label>
                  <input type="text" id="profile-name" class="form-input" value="Olaitan Adebayo" readonly tabindex="-1" />
                </div>
                <div>
                  <label for="profile-email" class="form-label">Email</label>
                  <input type="email" id="profile-email" class="form-input" value="olaitan@lg.gov" />
                </div>
                <div>
                  <label for="profile-staff-id" class="form-label">Staff ID</label>
                  <input type="text" id="profile-staff-id" class="form-input" value="STF001" readonly tabindex="-1" />
                </div>
                <div>
                  <label for="profile-department" class="form-label">Department</label>
                  <input type="text" id="profile-department" class="form-input" value="Administration" readonly tabindex="-1" />
                </div>
              </div>
              <div class="flex flex-gap-4 mt-6">
                <button type="submit" class="btn btn-primary">Save Changes</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Change Password -->
        <div class="card shadow-sm">
          <div class="card-header p-6">
            <h2 class="section-title">Change Password</h2>
          </div>
          <div class="card-body p-6">
            <form onsubmit="changePassword(event)">
              <div class="grid-2-col">
                <div>
                  <label for="current-password" class="form-label">Current Password</label>
                  <div class="password-input-wrapper" style="position: relative;">
                    <input 
                      type="password" 
                      id="current-password" 
                      class="form-input" 
                      required 
                      style="padding-right: calc(var(--flowbite-space-3) * 2 + 20px);"
                    />
                  </div>
                </div>
                <div>
                  <label for="new-password" class="form-label">New Password</label>
                  <div class="password-input-wrapper" style="position: relative;">
                    <input 
                      type="password" 
                      id="new-password" 
                      class="form-input" 
                      required 
                      style="padding-right: calc(var(--flowbite-space-3) * 2 + 20px);"
                    />
                  </div>
                </div>
                <div>
                  <label for="confirm-password" class="form-label">Confirm New Password</label>
                  <div class="password-input-wrapper" style="position: relative;">
                    <input 
                      type="password" 
                      id="confirm-password" 
                      class="form-input" 
                      required 
                      style="padding-right: calc(var(--flowbite-space-3) * 2 + 20px);"
                    />
                  </div>
                </div>
              </div>
              <div id="password-error" class="mb-4 error-message hidden"></div>
              <div class="flex flex-gap-4 mt-6">
                <button type="submit" class="btn btn-primary">Change Password</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Confirmation Modal -->
      <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="card shadow-lg max-w-300 w-full modal-content">
          <div class="card-body p-4">
            <p id="confirmation-message" class="text-sm mb-4"></p>
            <div class="flex flex-gap-2 justify-end">
              <button id="confirmation-yes" class="btn btn-primary">Yes</button>
              <button id="confirmation-no" class="btn btn-outline">No</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script type="module">
      import { getCurrentUser, updatePassword } from '/src/services/auth.js';
      import { updateStaff } from '/src/services/staff.js';

      // Initialize currentUser from window (set by initStaffProfilePage)
      let currentUser = window.currentUser || null;

      // Custom confirmation function with Yes/No buttons
      window.showConfirmation = function(message) {
        return new Promise((resolve) => {
          const modal = document.getElementById('confirmation-modal');
          const messageEl = document.getElementById('confirmation-message');
          const yesBtn = document.getElementById('confirmation-yes');
          const noBtn = document.getElementById('confirmation-no');

          if (!modal || !messageEl || !yesBtn || !noBtn) {
            // Fallback to native confirm if modal elements not found
            resolve(confirm(message));
            return;
          }

          // Set message
          messageEl.textContent = message;

          // Remove existing event listeners by cloning buttons
          const newYesBtn = yesBtn.cloneNode(true);
          const newNoBtn = noBtn.cloneNode(true);
          yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
          noBtn.parentNode.replaceChild(newNoBtn, noBtn);

          // Show modal
          modal.classList.remove('hidden');

          // Handle Yes button
          newYesBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            resolve(true);
          });

          // Handle No button
          newNoBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            resolve(false);
          });
        });
      };

      // Profile loading is now handled by afterEnter hook in routes.js
      // No need for loadProfile() function - it's in staff-profile-init.js

      window.updateProfile = async function(event) {
        event.preventDefault();
        
        // Get current user (from window or fetch if not available)
        if (!currentUser) {
          currentUser = window.currentUser;
        }
        if (!currentUser) {
          const { user } = await getCurrentUser();
          currentUser = user;
        }
        
        if (!currentUser) {
          alert('Failed to get user information');
          return;
        }
        
        // Show confirmation before updating
        const confirmed = await window.showConfirmation('Are you sure you want to update your personal information?');
        if (!confirmed) {
          return;
        }
        
        try {
          const email = document.getElementById('profile-email').value;
          const { data, error } = await updateStaff(currentUser.id, { email });

          if (error) {
            alert('Failed to update profile: ' + error.message);
            return;
          }

          alert('Profile updated successfully!');
          // Reload profile data using the initialization utility
          const { initStaffProfilePage } = await import('/src/utils/staff-profile-init.js');
          await initStaffProfilePage();
        } catch (error) {
          console.error('Error updating profile:', error);
          alert('Failed to update profile');
        }
      };

      window.changePassword = async function(event) {
        event.preventDefault();
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;

        if (newPassword !== confirmPassword) {
          const errorDiv = document.getElementById('password-error');
          errorDiv.classList.remove('hidden');
          errorDiv.textContent = 'New passwords do not match';
          return;
        }

        if (newPassword.length < 6) {
          const errorDiv = document.getElementById('password-error');
          errorDiv.classList.remove('hidden');
          errorDiv.textContent = 'Password must be at least 6 characters';
          return;
        }

        // Show confirmation before changing password
        const confirmed = await window.showConfirmation('Are you sure you want to change your password?');
        if (!confirmed) {
          return;
        }

        try {
          const { error } = await updatePassword(newPassword);
          if (error) {
            const errorDiv = document.getElementById('password-error');
            errorDiv.classList.remove('hidden');
            errorDiv.textContent = error.message || 'Failed to change password';
            return;
          }

          alert('Password changed successfully!');
          // Reset form after successful password change
          document.getElementById('current-password').value = '';
          document.getElementById('new-password').value = '';
          document.getElementById('confirm-password').value = '';
          document.getElementById('password-error').classList.add('hidden');
        } catch (error) {
          console.error('Error changing password:', error);
          alert('Failed to change password');
        }
      };

      // Profile loading is now handled by afterEnter hook in routes.js
      // No need to call loadProfile() here - it will be called when route is entered
    </script>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>
